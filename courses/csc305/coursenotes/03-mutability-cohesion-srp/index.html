<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-site-verification" content="hIU2NRFm9Pwt76Z9R8DR92m2-kC85IQw6eIS3Ag7y7U" />

	<title>More on encapsulation, immutability, cohesion - Ayaan M. Kazerouni</title>

	<link rel="stylesheet" href="/css/main.css" type="text/css">
  <link rel="stylesheet" href="/assets/academicons/css/academicons.min.css">
  <link rel="stylesheet" href="/css/github.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
	<link rel="canonical" href="https://ayaankazerouni.org/courses/csc305/coursenotes/03-mutability-cohesion-srp/">
	<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,700,800,600' rel='stylesheet' type='text/css'>
	<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
	<link href='https://fonts.googleapis.com/css?family=Muli:400,300' rel='stylesheet' type='text/css'>
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
</head>


<body>
  <main class="coursenotes">
  
  
  
  
  <p>
    (Coursenotes for <a href="/courses/csc305">CSC 305 Individual Software Design and Development</a>)
  </p>
  
  <h1>More on encapsulation, immutability, cohesion</h1>
    <div class="content-box" style="border: none;">
      <div class="content">
        
        <h2 id="topics">Topics</h2>

<ul>
  <li>
    <p>Review — what are the good programming practices we’ve learned about so far?</p>
  </li>
  <li>A bit more about encapsulation</li>
  <li>Mutability</li>
  <li>Cohesion and the single responsibility principle</li>
</ul>

<h2 id="a-bit-more-on-encapsulation">A bit more on encapsulation</h2>

<p><strong>EJ15</strong> Minimise the accessibility of classes and members</p>

<p>Different access modifiers:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">private</code> – accessible only to the class they’re in</li>
  <li>package private (no keyword) – accessible only to classes within the same package</li>
  <li><code class="language-plaintext highlighter-rouge">protected</code> – accessible within the same package and to subclasses</li>
  <li><code class="language-plaintext highlighter-rouge">public</code> – accessible to everyone</li>
</ul>

<p>Instance fields of public classes should rarely be public. Some exceptions exist, like the <a href="https://docs.oracle.com/en/java/javase/19/docs/api/java.desktop/java/awt/Point.html"><code class="language-plaintext highlighter-rouge">Point</code></a> and <a href="https://docs.oracle.com/en/java/javase/19/docs/api/java.desktop/java/awt/Dimension.html"><code class="language-plaintext highlighter-rouge">Dimension</code></a> classes in the Java standard library.A</p>

<p>This opens up the <code class="language-plaintext highlighter-rouge">Dimension</code> class in particular (used to encapsulate the 2d dimensions of a component in, say, a desktop application) to some potential issues. For example, the Javadoc for says the following:</p>

<blockquote>
  <p>Normally the values of width and height are non-negative integers. The constructors that allow you to create a dimension do not prevent you from setting a negative value for these properties. If the value of width or height is negative, the behavior of some methods defined by other objects is undefined.</p>
</blockquote>

<p>Since the <code class="language-plaintext highlighter-rouge">Dimension</code> class has public, <em>mutable</em> fields for <code class="language-plaintext highlighter-rouge">width</code> and <code class="language-plaintext highlighter-rouge">height</code>, they can be freely changed by clients, with no validation done on the incoming values.
Ideally, we’d want to use mutator (“setter”) methods to mutate these values, or better yet, to return a new object with the new values. This way, we can check the new values for validity, and throw a decidedly “defined” exception instead of simply saying the behaviour is undefined.</p>

<p>For the <code class="language-plaintext highlighter-rouge">Point</code> class, an argument can be made that the class is a simple container for two integer values—x and y coordinates. Making them <code class="language-plaintext highlighter-rouge">private</code> and exposing them through getters and setters would be overkill, especially since any input validation is already done by the type system (i.e., x and y can only be <code class="language-plaintext highlighter-rouge">int</code>s). If you need more validation (e.g., to only allow positive integers), you can create a new abstraction to handle that.</p>

<p>Note also that the <code class="language-plaintext highlighter-rouge">Point</code> Javadoc doesn’t say that it’s specifically a point representing a location in desktop windows—if that were the case, then we <em>would</em> only want to allow positive numbers. But that’s not part of the <code class="language-plaintext highlighter-rouge">Point</code> <em>contract</em>, so it’s not something we can or should rely on. This is as opposed to the <code class="language-plaintext highlighter-rouge">Dimension</code> Javadoc, where negative numbers are possible even though they would not make sense in that context.</p>

<h2 id="mutability">Mutability</h2>

<p>When something is <em>mutable</em>, that means it is possible for it to change or be changed. In the example above, the <code class="language-plaintext highlighter-rouge">width</code> and <code class="language-plaintext highlighter-rouge">height</code> fields in the <code class="language-plaintext highlighter-rouge">Dimension</code> class are mutable, since they are not declared to be <code class="language-plaintext highlighter-rouge">final</code> fields. The same goes for the <code class="language-plaintext highlighter-rouge">Point</code> class’s <code class="language-plaintext highlighter-rouge">x</code> and <code class="language-plaintext highlighter-rouge">y</code> values.</p>

<p>This means that <code class="language-plaintext highlighter-rouge">Dimension</code> and <code class="language-plaintext highlighter-rouge">Point</code> objects are themselves mutable, since their internal state is mutable.</p>

<p>In contrast, the <code class="language-plaintext highlighter-rouge">String</code> class is <em>immutable</em>. Once a <code class="language-plaintext highlighter-rouge">String</code> has been created, it cannot be changed.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="n">myString</span> <span class="o">=</span> <span class="s">"CSC 305 Individual Software Desine and Development"</span><span class="o">;</span>
<span class="n">myString</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">"Desine"</span><span class="o">,</span> <span class="s">"Design"</span><span class="o">);</span>

<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">myString</span><span class="o">);</span> <span class="c1">// prints "CSC 305 Individual Software Desine and Development"</span>
</code></pre></div></div>

<p>In the code above, the <code class="language-plaintext highlighter-rouge">String::replace</code> method call returns a <em>new</em> <code class="language-plaintext highlighter-rouge">String</code> with the transformation applied. If we wanted to store that new value, we would need to re-assign the <code class="language-plaintext highlighter-rouge">myString</code> variable to that returned value.</p>

<p><strong>EJ17: Minimise mutability</strong></p>

<p>An immutable class is a class whose instances cannot be modified. You can achieve this by not providing methods that modify the instance variables of a class, and ensure that the class cannot be extended (declare it as a <code class="language-plaintext highlighter-rouge">final class</code>).</p>

<p class="callout todo">Critique the following code. Is the <code class="language-plaintext highlighter-rouge">Person</code> class below immutable? If not, what would it take to make it immutable?</p>

<p><strong><code class="language-plaintext highlighter-rouge">Person.java</code></strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Date</span> <span class="n">dateOfBirth</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Person</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">Date</span> <span class="n">dateOfBirth</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dateOfBirth</span> <span class="o">=</span> <span class="n">dateOfBirth</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Date</span> <span class="nf">getDateOfBirth</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">dateOfBirth</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDate</span><span class="o">(</span><span class="nc">Date</span> <span class="n">dateOfBirth</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dateOfBirth</span> <span class="o">=</span> <span class="n">dateOfBirth</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Strategies for making a class immutable:</p>

<ul>
  <li>Make fields <code class="language-plaintext highlighter-rouge">private</code> and <code class="language-plaintext highlighter-rouge">final</code></li>
  <li>Make the class <code class="language-plaintext highlighter-rouge">final</code> (meaning it can’t be extended)</li>
  <li>Don’t provide public mutator methods</li>
  <li>And finally, you need to ensure exclusive access to any mutable components of the class</li>
</ul>

<p>What do we mean by that last point? Consider the point that the <code class="language-plaintext highlighter-rouge">Date</code> object in Java is <em>mutable</em>. That means that, with access to the <code class="language-plaintext highlighter-rouge">dateOfBirth</code> reference (e.g., using the public accessor method we provided in <code class="language-plaintext highlighter-rouge">Person</code>), a client could use <code class="language-plaintext highlighter-rouge">Date</code> class’s mutator methods to change its value! This renders our <code class="language-plaintext highlighter-rouge">Person</code> no longer immutable.</p>

<p>Marking the <code class="language-plaintext highlighter-rouge">dateOfBirth</code> as <code class="language-plaintext highlighter-rouge">final</code> only prevents it from being assigned a new value. It doesn’t prevent us from calling its own mutator methods on it.</p>

<p>This can lead to “attacks” on the <code class="language-plaintext highlighter-rouge">Person</code> class’s immutability, taking advantage of the mutable nature of its internal fields.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">Person</span> <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Person</span><span class="o">(</span><span class="s">"Steph Curry"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>

  <span class="nc">Date</span> <span class="n">dateOfBirth</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">getDateOfBirth</span><span class="o">();</span>
  <span class="n">dateOfBirth</span><span class="o">.</span><span class="na">setTime</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span> <span class="c1">// Steph is now born at the beginning of time.</span>
<span class="o">}</span>
</code></pre></div></div>

<p class="callout ponder">How would you account for the <code class="language-plaintext highlighter-rouge">Date</code> class’s mutability if you wanted to make the <code class="language-plaintext highlighter-rouge">Person</code> class immutable?</p>

<p><strong>EJ50 Make defensive copies of mutable objects when needed.</strong></p>

<p>This includes when we’re giving others a reference to any of our internal components that happen to mutable, or when we’re <em>using</em> objects given to us by others that happen to be mutable.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">Person</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">Date</span> <span class="n">dateOfBirth</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">dateOfBirth</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">(</span><span class="n">dateOfBirth</span><span class="o">.</span><span class="na">getTime</span><span class="o">());</span>
<span class="o">}</span>

<span class="c1">// ... rest of the class stays the same</span>

<span class="kd">public</span> <span class="nc">Date</span> <span class="nf">getDateOfBirth</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">Date</span><span class="o">(</span><span class="n">dateOfBirth</span><span class="o">.</span><span class="na">getTime</span><span class="o">());</span> 
<span class="o">}</span>
</code></pre></div></div>

<h3 id="whats-the-point-of-immutability">What’s the point of immutability?</h3>

<p class="callout ponder">What do you think are some benefits of immutability? (Can answer in general or specifically in an object-oriented context.)</p>

<p>There are many benefits to creating immutable objects.</p>

<ul>
  <li><strong>Simplicity</strong>. Immutable objects can be in exactly one state—the state in which they were created. This means that you can check invariants in the constructor for the object, and those invariants are guaranteed to hold for the lifetime of the object.
<strong>Changes become visible</strong>. If changes are to be made, functions called on the object would result in the creation and return of a <em>new</em> object. You can read code and reason about the chain of events that occur from a sequence of function calls, resting assured that there were no invisible changes that occurred within those functions. This can make program comprehension significantly easier, which in turn simplifies things like debugging, contributing to an existing codebase, or refactoring.</li>
  <li><strong>Immutable objects are thread-safe</strong>. If objects are immutable, they cannot be corrupted by competing threads. This means that objects can be shared among multiple threads freely. Algorithms operating on immutable objects are more easily parallelisable, since the object is guaranteed to always be in a “valid” state, i.e., it hasn’t been inappropriately modified by multiple clients who are unaware of each other.</li>
  <li><strong>Failure atomicity</strong>. Immutable objects guarantee <em>failure atomicity</em>. “Atomicity” is when a sequence of actions are carried out “as one”. For example, consider the action of enrolling for a course at Cal Poly. There a number of steps that need to be taken to perform this “single action”:
    <ul>
      <li>Check if you meet pre-requisites</li>
      <li>Check the course capacity</li>
      <li>Get added to the course according to the registrar’s rolls</li>
      <li>Get added to the course Canvas</li>
      <li>Get added to the course mailing list</li>
    </ul>
  </li>
</ul>

<p>If the above actions were performed <em>atomically</em>, we are saying that the above actions would <em>all succeed</em> or <em>all fail</em>. Anything in the middle can result in inconsistent states, e.g., you’re added to the course Canvas, but the registrar has no idea that you’re in the course.</p>

<p>In an immutable object, we avoid the possibility of an object in an inconsistent state (e.g., in an an exception occurs halfway through a function). If a function call failed for some internal reason, the original object is left untouched. That is, the “client” either has a reference to the original object (in a valid state) or the result of a successful function call (also a valid state).</p>

<ul>
  <li><strong>Composability</strong>. You can chain or “compose” abstractions (objects or functions) that have immutability together to solve larger problems. For example, consider the <code class="language-plaintext highlighter-rouge">String</code> class. Because each method returns a copy of the <code class="language-plaintext highlighter-rouge">String</code>, you can chain function calls:</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="n">myString</span> <span class="o">=</span> <span class="s">"    this is a string   "</span><span class="o">;</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">myString</span><span class="o">.</span><span class="na">trim</span><span class="o">().</span><span class="na">toUpperCase</span><span class="o">());</span> <span class="c1">// prints "THIS IS A STRING"</span>
</code></pre></div></div>

<p>This may seem like a small benefit, but when functions are defined at the right level abstraction, you can compose them to solve problems of ever-increasing complexity. For example, consider the <code class="language-plaintext highlighter-rouge">map</code>, <code class="language-plaintext highlighter-rouge">filter</code>, and <code class="language-plaintext highlighter-rouge">reduce</code> patterns.</p>

<p>One drawback of immutability is <em>performance</em>. It can be costly to create a new Object each time some changes have to be made. This cost tends to be overstimated in most cases since optimisations in the programming language can absorb most of the cost (by not actually copying data that doesn’t change, advanced garbage collection techniques, etc.). But in programs with large, complex objects that frequently change state (e.g., characters in games) immutability may be too expensive to justify.</p>

<p>One strategy to manage this cost for “large” objects is to create a “companion” class that is mutable, and is used purely for the purpose of performing operations that require mutability. One example is the <code class="language-plaintext highlighter-rouge">StringBuilder</code> class.</p>

<h2 id="cohesion">Cohesion</h2>

<p>The degree to which a module (class, function, package) has a single, well-focused responsibility. A module should <em>do one thing</em>. What does “one thing” mean in this context? It is highly dependent on the problem you’re solving and abstractions you’ve chosen to help you.</p>

<p>Why are cohesive modules good?</p>

<ul>
  <li>For starters, a module that does one thing is much easier to reason about than a module that handles several pieces of unrelated logic.</li>
  <li>If functionality is appropriately isolated in a module, it becomes easier to test. That is, you can test for individual requirements without other requirements getting in the way.</li>
</ul>

<p>For example, consider a text-based Tic Tac Toe game you’re making for Lab 2. A solution with <strong>highly cohesive</strong> modules might have classes that handle the following responsibilities, <em>separately</em>.</p>

<ul>
  <li>Managing the board state.</li>
  <li>Keeping track of the state of the current game.</li>
  <li>Managing the user interface. That is, handling all interactions with the user.</li>
  <li>Managing communication between the UI and the game.</li>
</ul>

<p>A solution with <strong>low cohesion</strong> might tightly <em>couple</em> two or more of the above modules together. For example, to handle the job</p>

<blockquote>
  <p>“place <code class="language-plaintext highlighter-rouge">X</code> at the top-right corner”</p>
</blockquote>

<p>a low-cohesion solution might place the <code class="language-plaintext highlighter-rouge">X</code> and save that information, handle the update of the user interface, and check whether the user has won the game or not. This displays low cohesion. The function is doing at least three things.</p>

<p>Moreover, future changes are rendered difficult with this design. Suppose you wanted to replace the text-based user interface with a graphical user interface. Instead of swapping out the UI (like the Formula 1 pit crew swaps out the front/rear wing), you now need to fiddle with the Tic Tac Toe game logic as well.</p>

<p>Does this all sound a lot like the arguments we made against tight <em>coupling</em> last week? Good! The two ideas of coupling and cohesion go hand-in-hand. A way to reduce coupling between modules is to ensure that individual modules have a <em>single responsibility</em>.</p>

<p>Remember: <strong>Loose Coupling, Tight Cohesion</strong></p>

<h2 id="an-example-in-the-wild">An example in the wild</h2>

<p>(we didn’t get to this, but we’ll talk about this on Thursday)</p>

<p>Consider the following chapter written by <a href="http://aosabook.org/en/intro1.html#crook-james">James Crook</a> about the <a href="http://aosabook.org/en/audacity.html">user interface of Audacity</a>, a popular open-source application for sound recording and mixing.</p>

<p>The chapter is pretty long and worth a read in its entirety<sup id="fnref:aosa" role="doc-noteref"><a href="#fn:aosa" class="footnote" rel="footnote">1</a></sup>, but we’ll focus on section 2.4 <em>The TrackPanel</em>.</p>

<p class="callout todo">Take a moment to read the referenced section.</p>

<p>The author is describing exactly the kind of problem we discussed with the Tic Tac Toe example. Namely, parts of the user interface are deeply coupled with the domain-specific logic that is being implemented. The reasons for this choice are related to other, earlier tradeoffs regarding a third-party library used in Audacity (wxWidgets).</p>

<p>The Summary section puts it nicely (emphasis mine):</p>

<blockquote>
  <p>In the TrackPanel of Audacity we needed to go outside the features that could easily be got from existing widgets. As a result we rolled our own ad hoc system. <strong>There is a cleaner system with widgets and sizers and logically distinct application level objects struggling to come out of the TrackPanel.</strong></p>
</blockquote>

<hr />

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:aosa" role="doc-endnote">
      <p>It’s from the book collection <em>The Architecture of Open-Source Applications</em>, edited by Amy Brown and Greg Wilson. The books are pretty cool because they contain design descriptions of large and mature open-source projects written by the project maintainers themselves. This gives us a unique insight into the design decisions and tradeoffs that go into engineering large software. <a href="#fnref:aosa" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

    </div>
    
    
    </article>
  </main>
</body>
</html>
